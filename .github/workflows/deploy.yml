name: Auto Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger from GitHub

jobs:
  deploy:
    name: Deploy to Hetzner Server
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Deploy and Restart All Services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "üîÑ Starting auto-deployment..."
            echo "=================================================="
            
            # Navigate to project directory
            cd /root/crypto-tracker
            
            # Store current commit before pulling
            BEFORE_COMMIT=$(git rev-parse HEAD)
            
            # Pull latest changes from GitHub
            echo "üì• Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            
            AFTER_COMMIT=$(git rev-parse HEAD)
            
            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only $BEFORE_COMMIT $AFTER_COMMIT)
            echo "üìù Changed files:"
            echo "$CHANGED_FILES"
            echo ""
            
            # Check if frontend changed
            if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
              echo "ÔøΩ Frontend changes detected - rebuilding..."
              
              # Stop and remove frontend container
              docker-compose stop frontend
              docker rm -f crypto-tracker_frontend_1 || true
              
              # Rebuild frontend with no cache (to get new .env.production)
              cd frontend
              docker build --no-cache -t crypto-tracker_frontend .
              cd ..
              
              # Start fresh frontend container
              docker-compose up -d frontend
              
              echo "‚úÖ Frontend rebuilt and restarted"
              sleep 5
            else
              echo "‚ÑπÔ∏è  No frontend changes - skipping rebuild"
            fi
            
            # Check if backend changed
            if echo "$CHANGED_FILES" | grep -q "^backend/"; then
              echo "ÔøΩ Backend changes detected..."
              
              # Check if requirements.txt changed
              if echo "$CHANGED_FILES" | grep -q "requirements.txt"; then
                echo "üì¶ Python dependencies changed - rebuilding backend..."
                docker-compose build backend1
              fi
              
              # Restart backend services
              echo "üîÑ Restarting backend services..."
              docker-compose restart backend1 celery celery-beat
              
              echo "‚úÖ Backend restarted"
              sleep 5
            else
              echo "‚ÑπÔ∏è  No backend changes"
            fi
            
            # Check if nginx config changed
            if echo "$CHANGED_FILES" | grep -q "^nginx/"; then
              echo "ÔøΩ Nginx config changed - restarting..."
              docker-compose restart nginx
              echo "‚úÖ Nginx restarted"
            fi
            
            # Run migrations if migration files changed
            if echo "$CHANGED_FILES" | grep -q "migrations/"; then
              echo "üìä Running database migrations..."
              docker-compose exec -T backend1 python manage.py migrate --noinput
              echo "‚úÖ Migrations complete"
            fi
            
            # Wait for all services to stabilize
            echo ""
            echo "‚è≥ Waiting for services to stabilize..."
            sleep 10
            
            # Show running containers status
            echo ""
            echo "=================================================="
            echo "‚úÖ Deployment Complete!"
            echo "=================================================="
            echo ""
            echo "üìä Container Status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep crypto-tracker
            
            echo ""
            echo "üåê Site: https://volusignal.com"
            echo "üîí SSL: Enabled"
            echo "üìÖ Deployed: $(date)"
            echo "üìù Commit: $AFTER_COMMIT"
            echo "=================================================="
