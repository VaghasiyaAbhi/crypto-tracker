name: Auto Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger from GitHub

jobs:
  deploy:
    name: Deploy to Hetzner Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy and Restart All Services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ”„ Starting auto-deployment..."
            echo "=================================================="
            
            # Navigate to project directory
            cd /root/crypto-tracker
            
            # Pull latest changes from GitHub
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            # Rebuild and restart all services (fresh deployment)
            echo ""
            echo "ğŸ”¨ Rebuilding all Docker containers..."
            docker-compose build --no-cache
            
            echo ""
            echo "ğŸ”„ Restarting all services..."
            docker-compose down
            docker-compose up -d
            
            # Wait for services to start
            echo ""
            echo "â³ Waiting for services to initialize (30 seconds)..."
            sleep 30
            
            # Run migrations if needed
            echo ""
            echo "ğŸ“Š Running database migrations..."
            docker-compose exec -T backend1 python manage.py migrate --noinput || echo "Migrations already applied"
            
            # Collect static files
            echo ""
            echo "ï¿½ Collecting static files..."
            docker-compose exec -T backend1 python manage.py collectstatic --noinput || echo "Static files already collected"
            
            # Show running containers status
            echo ""
            echo "=================================================="
            echo "âœ… Deployment Complete!"
            echo "=================================================="
            echo ""
            docker-compose ps
            
            echo ""
            echo "ğŸŒ Your site is live at: https://volusignal.com"
            echo "ğŸ”’ SSL: Enabled"
            echo "ğŸ“… Deployed: $(date)"
            echo "=================================================="
