name: Auto Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger from GitHub

jobs:
  deploy:
    name: Deploy to Hetzner Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy and Restart All Services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ”„ Starting auto-deployment..."
            echo "=================================================="
            
            # Navigate to project directory
            cd /root/crypto-tracker
            
            # Pull latest changes from GitHub
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git reset --hard origin/main
            git pull origin main
            
            # Check if Docker images need rebuilding (only if Dockerfile changed)
            echo ""
            echo "ï¿½ Checking for Docker changes..."
            if git diff HEAD@{1} HEAD --name-only | grep -E "Dockerfile|requirements.txt|package.json|package-lock.json"; then
              echo "ğŸ“¦ Dependencies changed - rebuilding images..."
              docker-compose build
            else
              echo "âœ… No dependency changes - skipping rebuild"
            fi
            
            # Restart only affected services (backend, frontend, workers)
            echo ""
            echo "ğŸ”„ Restarting application services..."
            docker-compose restart backend1 data-worker calc-worker celery-worker celery-beat frontend
            
            # Wait for services to start
            echo ""
            echo "â³ Waiting for services to restart (10 seconds)..."
            sleep 10
            
            # Run migrations if needed (only if migration files changed)
            echo ""
            echo "ğŸ“Š Checking for database migrations..."
            if git diff HEAD@{1} HEAD --name-only | grep -E "migrations/"; then
              echo "Running migrations..."
              docker-compose exec -T backend1 python manage.py migrate --noinput
            else
              echo "âœ… No migration changes detected"
            fi
            
            # Collect static files (only if static files changed)
            echo ""
            echo "ğŸ“ Checking for static file changes..."
            if git diff HEAD@{1} HEAD --name-only | grep -E "static/|frontend/"; then
              echo "Collecting static files..."
              docker-compose exec -T backend1 python manage.py collectstatic --noinput || echo "Static files already up to date"
            else
              echo "âœ… No static file changes detected"
            fi
            
            # Show running containers status
            echo ""
            echo "=================================================="
            echo "âœ… Deployment Complete!"
            echo "=================================================="
            echo ""
            docker-compose ps
            
            echo ""
            echo "ğŸŒ Your site is live at: https://volusignal.com"
            echo "ğŸ”’ SSL: Enabled"
            echo "ğŸ“… Deployed: $(date)"
            echo "=================================================="
