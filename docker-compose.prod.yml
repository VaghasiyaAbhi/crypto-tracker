# docker-compose.prod.yml (override)
# Production override â€” use pre-built images (registry-agnostic).
# Set TAG in your shell: export TAG=$(git rev-parse --short HEAD) or a version string.

services:
  backend1:
    # Use registry-agnostic image names so CI/CD or the deployer can set the registry.
    image: crypto-tracker/backend:${TAG}
    env_file:
      - ./backend/.env.production
    # keep volumes/depends_on/healthcheck from base file

  celery-worker:
    image: crypto-tracker/backend:${TAG}
    command: celery -A project_config worker --loglevel=info --concurrency=2 --prefetch-multiplier=1 --max-memory-per-child=150000 --max-tasks-per-child=100
    env_file:
      - ./backend/.env.production

  celery-beat:
    image: crypto-tracker/backend:${TAG}
    command: celery -A project_config beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    env_file:
      - ./backend/.env.production

  data-worker:
    image: crypto-tracker/backend:${TAG}
    env_file:
      - ./backend/.env.production

  calc-worker:
    image: crypto-tracker/backend:${TAG}
    env_file:
      - ./backend/.env.production

  frontend:
    image: crypto-tracker/frontend:${TAG}
    env_file:
      - ./frontend/.env.production
    # Remove public port exposure; Nginx will front it.
    ports: []

# nginx, postgres, pgbouncer, redis inherit from base compose
